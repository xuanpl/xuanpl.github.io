<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ‹¾ç»ª Â· çµæ„Ÿæ—¥è®°</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ‹¾ç»ª">
    
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <style>
        :root { 
            --primary: #34495e; --accent: #d4af37; --bg: #f8f9fa; --card: #ffffff; --text: #2c3e50; 
            --danger: #e74c3c; --sub: #95a5a6; --mood-bg: #f0f2f5;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #ecf0f1; --accent: #f1c40f; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0;
                --sub: #7f8c8d; --mood-bg: #2c2c2c;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui; background: var(--bg); margin: 0; color: var(--text); padding-bottom: env(safe-area-inset-bottom); transition: background 0.3s; }
        
        /* æ²‰æµ¸å¼å…¨å±ä¿®æ­£ */
        .page { position: fixed; inset: 0; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: var(--bg); z-index: 10; overflow-y: auto; padding-top: env(safe-area-inset-top); }
        .page-hidden { transform: translateX(100%); opacity: 0; }

        .home-header { padding: 45px 25px 15px; }
        .home-header h1 { font-size: 26px; font-weight: 200; margin: 0; letter-spacing: 2px; }
        .mini-stats { display: flex; gap: 20px; margin-top: 15px; }
        .stat-group { display: flex; flex-direction: column; }
        .stat-label { font-size: 10px; color: var(--sub); text-transform: uppercase; }
        .stat-val { font-size: 19px; font-weight: 300; margin-top: 2px; }

        /* æ—¥å†ï¼šå­—å·ä¸æ¯”ä¾‹é‡åˆ¶ */
        .cal-section { margin: 15px; border-radius: 26px; background: var(--card); box-shadow: 0 10px 40px rgba(0,0,0,0.04); padding-bottom: 12px; }
        .cal-ctrl { display: flex; justify-content: space-between; align-items: center; padding: 22px 25px; }
        .nav-group { display: flex; align-items: center; gap: 22px; }
        .cal-btn { background: var(--mood-bg); border: none; width: 38px; height: 38px; border-radius: 50%; color: var(--text); display: flex; align-items: center; justify-content: center; }
        .today-btn { font-size: 12px; color: var(--accent); font-weight: 600; background: var(--mood-bg); padding: 7px 18px; border-radius: 20px; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); padding: 0 10px; gap: 2px; }
        .day { height: 62px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 16px; margin: 2px; position: relative; transition: transform 0.2s; }
        
        /* é˜³å†æ—¥æœŸï¼šé»„é‡‘æ¯”ä¾‹ 17px */
        .day span:first-child { font-size: 17px; font-weight: 600; }
        /* å†œå†ä¸èŠ‚æ—¥ï¼šæ¸…æ™°åº¦æå‡ */
        .day .l, .day .fest { font-size: 10px; margin-top: 4px; letter-spacing: 0.5px; opacity: 0.6; }
        .day .fest { color: var(--danger); font-weight: bold; opacity: 1; }

        .day.recorded { background: var(--mood-bg); }
        .day.is-today { background: var(--primary) !important; color: var(--bg); }
        .day.recorded::after { content: ''; position: absolute; bottom: 6px; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }
        .is-today.recorded::after { background: var(--bg); }

        /* é˜…è¯»æ¨¡å¼ï¼šæ’ç‰ˆç¾å­¦ */
        .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; position: sticky; top:0; background: var(--bg); z-index: 20; }
        .reading-container { padding: 35px 30px 100px; max-width: 650px; margin: 0 auto; }
        #title-v { font-size: 30px; font-weight: 700; margin-bottom: 14px; line-height: 1.3; }
        .meta-v { font-size: 13px; color: var(--sub); margin-bottom: 40px; border-left: 3px solid var(--accent); padding-left: 14px; }
        .text-v { font-size: 18px; line-height: 2.0; white-space: pre-wrap; color: var(--text); opacity: 0.95; letter-spacing: 0.4px; }

        .edit-input { width: 100%; border: none; font-size: 28px; font-weight: 600; outline: none; margin-bottom: 20px; background: transparent; color: var(--text); }
        .edit-area { width: 100%; height: 50vh; border: none; font-size: 18px; line-height: 1.8; outline: none; resize: none; background: transparent; color: var(--text); }
        
        .mood-tray { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 30px; padding-bottom: 10px; }
        .mood-tag { padding: 9px 18px; background: var(--mood-bg); border-radius: 22px; font-size: 13px; white-space: nowrap; color: var(--sub); border: 1px solid transparent; }
        .mood-tag.active { background: var(--card); border-color: var(--accent); color: var(--accent); font-weight: 600; }

        .btn-action { background: var(--primary); color: var(--bg); border: none; padding: 12px 26px; border-radius: 14px; font-weight: 600; font-size: 14px; }
        .btn-s { border: none; padding: 15px; border-radius: 18px; font-size: 12px; color: var(--sub); background: var(--card); transition: 0.2s; }
        .btn-s:active { transform: scale(0.96); opacity: 0.8; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 30px; }
        .modal-content { background: var(--card); border-radius: 30px; padding: 40px; width: 100%; max-width: 380px; }
        .modal-content input { width: 100%; padding: 16px; border: 1px solid var(--mood-bg); background: var(--bg); color: var(--text); border-radius: 15px; margin-bottom: 15px; font-size: 16px; text-align: center; }

        #auth-layer { position:fixed; inset:0; background:var(--bg); z-index:300; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #pwd-i { padding:16px; border:none; background:var(--mood-bg); color:var(--text); border-radius:24px; margin-bottom:30px; text-align:center; font-size: 26px; width:220px; caret-color: var(--accent); }
    </style>
</head>
<body>

<div id="pwd-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; font-weight:300">ä¿®æ”¹è®¿é—®å¯†ç </h3>
        <input type="password" id="old-pwd" placeholder="æ—§å¯†ç " autocomplete="off">
        <input type="password" id="new-pwd" placeholder="æ–°å¯†ç " autocomplete="off">
        <div style="display:flex; gap:12px;">
            <button class="btn-s" style="flex:1" onclick="closePwdModal()">å–æ¶ˆ</button>
            <button class="btn-action" style="flex:1" onclick="updatePassword()">ç¡®è®¤</button>
        </div>
    </div>
</div>

<div id="auth-layer">
    <h2 style="font-weight:200; letter-spacing:10px;">æ‹¾ç»ª</h2>
    <input type="password" id="pwd-i" placeholder="" autocomplete="new-password" spellcheck="false">
    <button class="btn-action" onclick="checkAuth()" style="width:150px; letter-spacing:2px;">å¼€å¯çµæ„Ÿ</button>
</div>

<div id="h-page" class="page">
    <div class="home-header">
        <div>
            <h1>æ‹¾ç»ª Â· çµæ„Ÿæ—¥è®°</h1>
            <div class="mini-stats">
                <div class="stat-group"><span class="stat-label">Total</span><span class="stat-val" id="s-total">0</span></div>
                <div class="stat-group"><span class="stat-label">Month</span><span class="stat-val" id="s-month">0</span></div>
                <div class="stat-group"><span class="stat-label">Words</span><span class="stat-val" id="s-words">0</span></div>
            </div>
        </div>
    </div>

    <div class="cal-section">
        <div class="cal-ctrl">
            <div id="cal-m-label" style="font-weight:600; font-size: 18px;">2026å¹´ 2æœˆ</div>
            <div class="nav-group">
                <button class="cal-btn" onclick="moveMonth(-1)">â—€</button>
                <div class="today-btn" onclick="goToday()">ä»Š</div>
                <button class="cal-btn" onclick="moveMonth(1)">â–¶</button>
            </div>
        </div>
        <div class="cal-grid" id="cal-g"></div>
    </div>

    <div style="padding: 10px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <button class="btn-s" style="grid-column: span 2; background: var(--mood-bg); color: var(--accent); font-weight: bold; font-size: 14px;" onclick="goRandom()">âœ¨ éšæœºæ¼«æ­¥æ—§çµæ„Ÿ</button>
        <button class="btn-s" onclick="exportJSON()">å¤‡ä»½ (Export)</button>
        <button class="btn-s" onclick="document.getElementById('file-i').click()">æ¢å¤ (Import)</button>
        <button class="btn-s" style="grid-column: span 2;" onclick="showPwdModal()">ä¿®æ”¹è®¿é—®å¯†ç </button>
        <button class="btn-s" style="grid-column: span 2; color: var(--danger); opacity: 0.5; font-size: 11px;" onclick="clearAllData()">âš ï¸ æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
        <input type="file" id="file-i" style="display:none" onchange="importJSON(this)">
    </div>
</div>

<div id="d-page" class="page page-hidden">
    <div class="toolbar">
        <button class="btn-s" onclick="closePage()">è¿”å›</button>
        <span id="d-date-title" style="font-size: 12px; font-weight: 600; opacity: 0.4; letter-spacing: 1px;"></span>
        <button id="main-action-btn" class="btn-action" onclick="toggleMode()">ç¼–è¾‘</button>
    </div>
    
    <div class="reading-container">
        <div id="v-box">
            <h2 id="title-v"></h2>
            <div class="meta-v" id="meta-v"></div>
            <div class="text-v" id="content-v"></div>
        </div>
        <div id="e-box" style="display:none">
            <div class="mood-tray" id="m-tray">
                <div class="mood-tag" onclick="setMood(this)">ğŸ˜Š å¹³é™</div>
                <div class="mood-tag" onclick="setMood(this)">ğŸ’¡ çµæ„Ÿ</div>
                <div class="mood-tag" onclick="setMood(this)">ğŸ“ æ€è€ƒ</div>
                <div class="mood-tag" onclick="setMood(this)">ğŸŒ¿ æˆé•¿</div>
                <div class="mood-tag" onclick="setMood(this)">â˜• æ‚ é—²</div>
                <div class="mood-tag" onclick="setMood(this)">ğŸš€ åŠ¨åŠ›</div>
                <div class="mood-tag" onclick="setMood(this)">ğŸ”‹ å……ç”µ</div>
                <div class="mood-tag" onclick="setMood(this)">ğŸŒˆ å¿«ä¹</div>
                <div class="mood-tag" onclick="setMood(this)">ğŸ¤” ç–‘æƒ‘</div>
            </div>
            <input type="text" id="e-title" class="edit-input" placeholder="è¾“å…¥çµæ„Ÿæ ‡é¢˜...">
            <textarea id="e-content" class="edit-area" placeholder="åœ¨æ­¤å¼€å¯éšç¬”è®°å½•..."></textarea>
            <div style="font-size:11px; color:var(--sub); display:flex; justify-content:space-between; align-items:center; margin-top:25px;">
                <span>å­—æ•°ç»Ÿè®¡ï¼š<b id="wc-d" style="color:var(--text)">0</b></span>
                <button style="border:none; background:none; color:var(--danger); font-size:11px; font-weight: bold;" onclick="doDel()">åˆ é™¤æ­¤ç¯‡</button>
            </div>
        </div>
    </div>
    <div id="save-hint" style="position:fixed; bottom:25px; right:25px; font-size:10px; color:var(--sub); font-weight: bold; pointer-events: none;"></div>
</div>

<script>
    let db, curMonth = new Date(), curKey = '', dataMap = new Map();
    let isEdit = false, autoSaveTimer = null;
    const PWD_KEY = 'shiguang_pwd_v11_shixu';

    function checkAuth() {
        const inputVal = document.getElementById('pwd-i').value;
        const saved = localStorage.getItem(PWD_KEY);
        if(!saved) {
            if(inputVal.length < 1) return alert("è¯·è®¾ç½®è§£é”å¯†ç ");
            localStorage.setItem(PWD_KEY, btoa(inputVal));
            start();
        } else if(btoa(inputVal) === saved) start();
        else { alert("å¯†ç é”™è¯¯"); document.getElementById('pwd-i').value = ""; }
    }

    function start() {
        document.getElementById('auth-layer').style.display='none';
        const req = indexedDB.open("ShinyDiaryV11Shixu", 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore("notes", {keyPath: "date"});
        req.onsuccess = (e) => { db = e.target.result; sync(); };
    }

    async function sync() {
        const tx = db.transaction("notes", "readonly");
        const store = tx.objectStore("notes");
        const all = await new Promise(r => store.getAll().onsuccess = (e) => r(e.target.result));
        dataMap.clear();
        let tw = 0, mc = 0;
        const prefix = curMonth.toLocaleDateString().split('/').slice(0,2).join('/');
        all.forEach(n => { dataMap.set(n.date, n); tw += (n.words || 0); if(n.date.startsWith(prefix)) mc++; });
        document.getElementById('s-total').innerText = all.length;
        document.getElementById('s-month').innerText = mc;
        document.getElementById('s-words').innerText = tw.toLocaleString();
        renderCal();
    }

    function renderCal() {
        const g = document.getElementById('cal-g'); g.innerHTML = '';
        const y = curMonth.getFullYear(), m = curMonth.getMonth();
        document.getElementById('cal-m-label').innerText = `${y}å¹´ ${m+1}æœˆ`;
        const first = new Date(y, m, 1).getDay();
        const days = new Date(y, m+1, 0).getDate();
        const today = new Date().toLocaleDateString();
        const offset = (first === 0 ? 6 : first - 1);
        for(let i=0; i<offset; i++) g.innerHTML += '<div></div>';
        for(let d=1; d<=days; d++) {
            const dateObj = new Date(y, m, d), k = dateObj.toLocaleDateString();
            const l = Solar.fromDate(dateObj).getLunar();
            let f = l.getFestivals()[0] || l.getJieQi() || "";
            if(f.length > 2) f = f.replace(/èŠ‚$/, "").substring(0, 2);
            const el = document.createElement('div');
            el.className = `day ${k===today?'is-today':''} ${dataMap.has(k)?'recorded':''}`;
            el.innerHTML = `<span>${d}</span>${f?`<span class="fest">${f}</span>` : `<span class="l">${l.getDayInChinese()}</span>`}`;
            el.onclick = () => openNote(k);
            g.appendChild(el);
        }
    }

    function openNote(k) {
        curKey = k; 
        document.getElementById('d-date-title').innerText = k.replace(/\//g, ' . ');
        const d = dataMap.get(k); if(d) showView(d); else enterEdit();
        document.getElementById('d-page').classList.remove('page-hidden');
    }

    function showView(d) {
        isEdit = false; document.getElementById('v-box').style.display='block'; document.getElementById('e-box').style.display='none';
        document.getElementById('main-action-btn').innerText='ç¼–è¾‘';
        document.getElementById('title-v').innerText=d.title || "Untitled";
        document.getElementById('meta-v').innerText=`${d.mood || 'ğŸ“ æ‹¾ç»ªè®°å½•'} Â· ${d.words} å­—`;
        document.getElementById('content-v').innerText=d.content;
    }

    function enterEdit() {
        isEdit = true; const d = dataMap.get(curKey);
        document.getElementById('v-box').style.display='none'; document.getElementById('e-box').style.display='block';
        document.getElementById('main-action-btn').innerText='ä¿å­˜';
        document.getElementById('e-title').value = d?d.title:''; document.getElementById('e-content').value = d?d.content:'';
        const activeMood = d?d.mood:'';
        document.querySelectorAll('.mood-tag').forEach(t => t.classList.toggle('active', t.innerText === activeMood));
        updateWC();
    }

    function save(isManual) {
        const c = document.getElementById('e-content').value;
        const moodEl = document.querySelector('.mood-tag.active');
        const d = { date: curKey, title: document.getElementById('e-title').value, content: c, mood: moodEl ? moodEl.innerText : '', words: calcWords(c) };
        const tx = db.transaction("notes", "readwrite");
        tx.objectStore("notes").put(d);
        tx.oncomplete = () => {
            dataMap.set(curKey, d); sync();
            if(isManual) showView(d); else {
                document.getElementById('save-hint').innerText="å·²è‡ªåŠ¨ä¿å­˜ "+new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                setTimeout(()=>document.getElementById('save-hint').innerText='', 2000);
            }
        };
    }

    function goRandom() {
        const keys = Array.from(dataMap.keys());
        if(keys.length === 0) return alert("è¿˜æ²¡æœ‰è®°å½•ä»»ä½•çµæ„Ÿå‘¢");
        document.getElementById('h-page').style.opacity = '0.5';
        setTimeout(() => {
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            openNote(randomKey);
            document.getElementById('h-page').style.opacity = '1';
        }, 200);
    }

    function setMood(el) {
        const wasActive = el.classList.contains('active');
        document.querySelectorAll('.mood-tag').forEach(t => t.classList.remove('active'));
        if(!wasActive) el.classList.add('active');
    }

    function showPwdModal() { document.getElementById('pwd-modal').style.display='flex'; }
    function closePwdModal() { document.getElementById('pwd-modal').style.display='none'; }
    function updatePassword() {
        const oldP = document.getElementById('old-pwd').value;
        const newP = document.getElementById('new-pwd').value;
        if(btoa(oldP) !== localStorage.getItem(PWD_KEY)) return alert("æ—§å¯†ç é”™è¯¯");
        localStorage.setItem(PWD_KEY, btoa(newP));
        alert("å¯†ç å·²æ›´æ–°"); closePwdModal();
    }

    async function clearAllData() { if(confirm("è¯¥æ“ä½œå°†æ¸…ç©ºæœ¬åœ°æ‰€æœ‰æ—¥è®°ï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½ï¼")) { const tx = db.transaction("notes", "readwrite"); tx.objectStore("notes").clear(); tx.oncomplete = () => { alert("å·²æ¸…ç©º"); sync(); }; } }
    async function exportJSON() { const tx = db.transaction("notes", "readonly"); tx.objectStore("notes").getAll().onsuccess = (e) => { const blob = new Blob([JSON.stringify(e.target.result)], {type:"application/json"}); const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`ShiXu_Backup_${new Date().toLocaleDateString()}.json`; a.click(); }; }
    function importJSON(i) { const r = new FileReader(); r.onload=(e)=>{ const data = JSON.parse(e.target.result); const tx = db.transaction("notes", "readwrite"); data.forEach(n => tx.objectStore("notes").put(n)); tx.oncomplete = () => { alert("å¯¼å…¥æˆåŠŸ"); sync(); }; }; r.readAsText(i.files[0]); }
    function toggleMode() { if(isEdit) save(true); else enterEdit(); }
    document.getElementById('e-content').addEventListener('input', () => { updateWC(); clearTimeout(autoSaveTimer); autoSaveTimer=setTimeout(()=>isEdit&&save(false), 3000); });
    function calcWords(t) { return (t.match(/[\u4e00-\u9fa5]/g)||[]).length + (t.match(/[a-zA-Z]+/g)||[]).length; }
    function updateWC() { document.getElementById('wc-d').innerText = calcWords(document.getElementById('e-content').value).toLocaleString(); }
    function closePage() { document.getElementById('d-page').classList.add('page-hidden'); }
    function moveMonth(s) { curMonth.setMonth(curMonth.getMonth()+s); sync(); }
    function goToday() { curMonth = new Date(); sync(); }
    function doDel() { if(confirm("ç¡®å®šåˆ é™¤è¿™ç¯‡çµæ„Ÿå—ï¼Ÿ")) { const tx = db.transaction("notes", "readwrite"); tx.objectStore("notes").delete(curKey); tx.oncomplete = () => { dataMap.delete(curKey); closePage(); sync(); }; } }

    window.onload = () => { setTimeout(() => { document.getElementById('pwd-i').value = ""; }, 150); };
</script>
</body>
</html>
