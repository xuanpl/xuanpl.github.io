<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ‹¾ç»ª Â· çµæ„Ÿæ—¥è®°</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --accent: #d4af37; --bg: #f8f9fa; --card: #ffffff; --text: #2c3e50; 
            --danger: #e74c3c; --sub: #525c68; --mood-bg: #e9ecef;
        }
        @media (prefers-color-scheme: dark) {
            :root { --primary: #ecf0f1; --accent: #f1c40f; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --sub: #a4b0be; --mood-bg: #2c2c2c; }
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background: var(--bg); overflow: hidden; }
        body { font-family: -apple-system, system-ui; color: var(--text); padding-bottom: env(safe-area-inset-bottom); }
        
        .page { position: fixed; inset: 0; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: var(--bg); z-index: 10; overflow-y: auto; padding-top: env(safe-area-inset-top); }
        .page-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
        
        .home-header { padding: 45px 25px 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .home-header h1 { font-size: 24px; font-weight: 200; margin: 0; letter-spacing: 2px; }
        .settings-btn { background: none; border: none; padding: 5px; cursor: pointer; }
        .settings-btn svg { width: 22px; height: 22px; fill: var(--sub); }
        
        .mini-stats { display: flex; gap: 20px; margin: 0 25px 20px; color: var(--sub); }
        .stat-group { display: flex; flex-direction: column; }
        .stat-label { font-size: 10px; text-transform: uppercase; opacity: 0.6; }
        .stat-val { font-size: 18px; font-weight: 300; margin-top: 2px; color: var(--text); }

        .cal-section { margin: 15px; border-radius: 26px; background: var(--card); box-shadow: 0 10px 40px rgba(0,0,0,0.04); padding-bottom: 15px; }
        .cal-ctrl { display: flex; justify-content: space-between; align-items: center; padding: 22px 25px; }
        .nav-group { display: flex; align-items: center; gap: 20px; }
        .today-btn { font-size: 12px; color: var(--accent); font-weight: 600; background: var(--mood-bg); padding: 7px 18px; border-radius: 20px; }
        .cal-btn { background: var(--mood-bg); border: none; width: 38px; height: 38px; border-radius: 50%; color: var(--text); display: flex; align-items: center; justify-content: center; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); padding: 0 12px; gap: 2px; }
        .day { height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 16px; margin: 2px; position: relative; }
        .day span:first-child { font-size: 17px; font-weight: 600; }
        .day .l { font-size: 9.5px; margin-top: 3px; letter-spacing: -0.2px; white-space: nowrap; }
        .day.recorded { background: var(--mood-bg); }
        .day.is-today { background: var(--primary) !important; color: var(--bg); }
        .day.recorded::after { content: ''; position: absolute; bottom: 6px; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; }

        .walk-box { margin: 10px 15px; }
        .walk-btn { width: 100%; background: var(--card); color: var(--accent); border: none; padding: 16px; border-radius: 20px; font-size: 14px; font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.02); }

        .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; position: sticky; top:0; background: var(--bg); z-index: 20; }
        .btn-pill { font-size: 14px; font-weight: 600; padding: 10px 24px; border-radius: 18px; border: none; background: var(--mood-bg); color: var(--primary); min-width: 90px; text-align: center; }
        .btn-save { background: var(--primary); color: var(--bg); }
        .btn-del { color: var(--danger); font-size: 13px; font-weight: bold; background: none; border: none; margin-right: 15px; }
        
        .reading-container { padding: 35px 30px 150px; max-width: 650px; margin: 0 auto; }
        #title-v { font-size: 30px; font-weight: 700; margin-bottom: 14px; line-height: 1.3; }
        .meta-v { font-size: 12px; color: var(--sub); margin-bottom: 35px; border-left: 3px solid var(--accent); padding-left: 14px; }
        .text-v { font-size: 18px; line-height: 1.9; color: var(--text); white-space: pre-wrap; opacity: 0.9; }

        .mood-trigger { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--mood-bg); border-radius: 22px; font-size: 13px; color: var(--sub); margin-bottom: 25px; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: flex-end; }
        .modal-content { background: var(--card); width: 100%; border-radius: 30px 30px 0 0; padding: 35px 25px; }
        .mood-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .mood-tag { padding: 10px 18px; background: var(--mood-bg); border-radius: 18px; font-size: 13px; color: var(--sub); border: 1px solid transparent; }
        .mood-tag.active { border-color: var(--accent); color: var(--accent); font-weight: 700; background: var(--card); }
        
        #auth-layer { position:fixed; inset:0; background:var(--bg); z-index:300; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #pwd-i { padding:16px; border:none; background:var(--mood-bg); color:var(--text); border-radius:24px; margin-bottom:30px; text-align:center; font-size: 28px; width:220px; }
    </style>
</head>
<body>

<div id="auth-layer">
    <h2 style="font-weight:200; letter-spacing:10px; margin-bottom:40px;">æ‹¾ç»ª</h2>
    <input type="password" id="pwd-i" placeholder="" autocomplete="off">
    <button class="btn-pill btn-save" onclick="checkAuth()" style="width:180px;">å¼€å¯çµæ„Ÿ</button>
</div>

<div id="settings-modal" class="modal" onclick="this.style.display='none'"><div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="margin:0 0 25px; font-weight:300">ç³»ç»Ÿè®¾ç½®</h3>
    <button class="btn-pill" style="width:100%; margin-bottom:12px; text-align:left;" onclick="exportJSON()">å¤‡ä»½çµæ„Ÿ (Export) â†’</button>
    <button class="btn-pill" style="width:100%; margin-bottom:12px; text-align:left;" onclick="document.getElementById('file-i').click()">æ¢å¤çµæ„Ÿ (Import) â†’</button>
    <button class="btn-pill" style="width:100%; margin-bottom:12px; text-align:left;" onclick="showPwdModal()">ä¿®æ”¹è®¿é—®å¯†ç  â†’</button>
    <button class="btn-pill" style="width:100%; color:var(--danger); text-align:left;" onclick="clearAllData()">æ¸…ç©ºæœ¬åœ°æ•°æ® âš ï¸</button>
    <input type="file" id="file-i" style="display:none" onchange="importJSON(this)">
    <button class="btn-pill btn-save" style="width:100%; margin-top:30px;" onclick="document.getElementById('settings-modal').style.display='none'">å…³é—­</button>
</div></div>

<div id="pwd-modal" class="modal" onclick="this.style.display='none'"><div class="modal-content" onclick="event.stopPropagation()">
    <h3>ä¿®æ”¹å¯†ç </h3>
    <input type="password" id="old-pwd" style="width:100%; padding:16px; margin-bottom:12px; border-radius:15px; border:1px solid var(--mood-bg); background:var(--bg); color:var(--text);" placeholder="æ—§å¯†ç ">
    <input type="password" id="new-pwd" style="width:100%; padding:16px; margin-bottom:25px; border-radius:15px; border:1px solid var(--mood-bg); background:var(--bg); color:var(--text);" placeholder="æ–°å¯†ç ">
    <button class="btn-pill btn-save" style="width:100%" onclick="updatePassword()">ç¡®è®¤ä¿®æ”¹</button>
</div></div>

<div id="mood-modal" class="modal" onclick="closeMoodModal()"><div class="modal-content" onclick="event.stopPropagation()">
    <div class="mood-grid" id="mood-grid-main">
        <div class="mood-tag" onclick="toggleMood(this)">ğŸ˜Š å¹³é™</div><div class="mood-tag" onclick="toggleMood(this)">ğŸ’¡ çµæ„Ÿ</div><div class="mood-tag" onclick="toggleMood(this)">ğŸ“ æ€è€ƒ</div>
        <div class="mood-tag" onclick="toggleMood(this)">ğŸŒ¿ æˆé•¿</div><div class="mood-tag" onclick="toggleMood(this)">â˜• æ‚ é—²</div><div class="mood-tag" onclick="toggleMood(this)">ğŸš€ åŠ¨åŠ›</div>
        <div class="mood-tag" onclick="toggleMood(this)">ğŸŒˆ å¿«ä¹</div><div class="mood-tag" onclick="toggleMood(this)">ğŸ¤” ç–‘æƒ‘</div><div class="mood-tag" onclick="toggleMood(this)">ğŸ˜¢ ä½è½</div>
    </div>
    <div style="display:flex; gap:10px;">
        <input type="text" id="custom-mood-i" placeholder="è‡ªå®šä¹‰å¿ƒæƒ…..." style="flex:1; border:none; background:var(--mood-bg); padding:12px; border-radius:15px; font-size:14px; color:var(--text);">
        <button class="btn-pill" onclick="addCustomMood()">æ·»åŠ </button>
    </div>
    <div id="selected-moods-display" style="margin-top:20px; display:flex; flex-wrap:wrap; gap:8px;"></div>
    <button class="btn-pill btn-save" style="width:100%; margin-top:25px;" onclick="closeMoodModal()">å®Œæˆ</button>
</div></div>

<div id="h-page" class="page">
    <div class="home-header">
        <h1>æ‹¾ç»ª</h1>
        <button class="settings-btn" onclick="document.getElementById('settings-modal').style.display='flex'">
            <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.13,5.91,7.62,6.29L5.23,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.72,8.87 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.81,11.68,4.81,12c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.50,0.38,1.03,0.70,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        </button>
    </div>
    <div class="mini-stats">
        <div class="stat-group"><span class="stat-label">Total</span><span class="stat-val" id="s-total">0</span></div>
        <div class="stat-group"><span class="stat-label">Month</span><span class="stat-val" id="s-month">0</span></div>
        <div class="stat-group"><span class="stat-label">Words</span><span class="stat-val" id="s-words">0</span></div>
    </div>
    <div class="cal-section">
        <div class="cal-ctrl"><div id="cal-m-label" style="font-weight:600; font-size:18px;"></div><div class="nav-group"><button class="cal-btn" onclick="moveMonth(-1)">â—€</button><div class="today-btn" onclick="goToday()">ä»Š</div><button class="cal-btn" onclick="moveMonth(1)">â–¶</button></div></div>
        <div class="cal-grid" id="cal-g"></div>
    </div>
    <div class="walk-box">
        <button class="walk-btn" onclick="goRandom()">âœ¨ éšæœºæ¼«æ­¥æ—§çµæ„Ÿ</button>
    </div>
</div>

<div id="d-page" class="page page-hidden">
    <div class="toolbar">
        <button class="btn-pill" onclick="closePage()">è¿”å›</button>
        <span id="d-date-title" style="font-size:12px; font-weight:700; opacity:0.3; letter-spacing:1px;"></span>
        <div id="v-tools"><button class="btn-del" onclick="doDel()">åˆ é™¤</button> <button class="btn-pill btn-save" onclick="enterEdit()">ç¼–è¾‘</button></div>
        <div id="e-tools" style="display:none"><button class="btn-pill btn-save" onclick="save(true)">ä¿å­˜</button></div>
    </div>
    <div class="reading-container">
        <div id="v-box"><h2 id="title-v"></h2><div class="meta-v" id="meta-v"></div><div class="text-v" id="content-v"></div></div>
        <div id="e-box" style="display:none">
            <div class="mood-trigger" id="mood-trigger-btn" onclick="openMoodModal()">è®°å½•æ­¤åˆ»å¿ƒæƒ…...</div>
            <input type="text" id="e-title" placeholder="ç»™ä»Šå¤©å®‰ä¸ªæ ‡é¢˜..." style="width:100%; border:none; background:none; font-size:26px; font-weight:600; margin-bottom:20px; outline:none; color:var(--text);">
            <textarea id="e-content" placeholder="å¿ƒæƒ…ã€éšç¬”ã€æˆ–æ˜¯æŸä¸ªç¬é—´çš„çµæ„Ÿ..." style="width:100%; border:none; background:none; font-size:18px; line-height:1.9; min-height:60vh; outline:none; color:var(--text);"></textarea>
            <div id="wc-d-box" style="font-size:11px; color:var(--sub); margin-top:20px; font-weight:700;">å­—æ•°ç»Ÿè®¡ï¼š<span id="wc-d">0</span></div>
        </div>
    </div>
    <div id="save-hint" style="position:fixed; bottom:30px; right:30px; font-size:11px; color:var(--sub); font-weight: bold; z-index:150;"></div>
</div>

<script>
    let db, curMonth = new Date(), curKey = '', dataMap = new Map();
    let isEditState = false, activeMoods = [], autoSaveTimer = null, isComposing = false, lastHiddenTime = 0;
    const PWD_KEY = 'ShiXu_Standard_V11_Official_PWD';

    function checkAuth() {
        const v = document.getElementById('pwd-i').value, s = localStorage.getItem(PWD_KEY);
        if(!s) { if(v.length < 1) return alert("è¯·è®¾ç½®è§£é”å¯†ç "); localStorage.setItem(PWD_KEY, btoa(v)); start(); }
        else if(btoa(v) === s) { start(); lastHiddenTime = 0; } else { alert("å¯†ç é”™è¯¯"); document.getElementById('pwd-i').value=''; }
    }

    function start() {
        document.getElementById('auth-layer').style.display='none';
        const req = indexedDB.open("ShiXu_Standard_V11_Official_DB", 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore("notes", {keyPath: "date"});
        req.onsuccess = (e) => { db = e.target.result; sync(); };
    }

    async function sync() {
        const tx = db.transaction("notes", "readonly");
        const all = await new Promise(r => tx.objectStore("notes").getAll().onsuccess = (e) => r(e.target.result));
        dataMap.clear(); let tw = 0, mc = 0;
        const prefix = curMonth.toLocaleDateString().split('/').slice(0,2).join('/');
        all.forEach(n => { dataMap.set(n.date, n); tw += (n.words || 0); if(n.date.startsWith(prefix)) mc++; });
        document.getElementById('s-total').innerText = all.length;
        document.getElementById('s-month').innerText = mc;
        document.getElementById('s-words').innerText = tw.toLocaleString();
        renderCal();
    }

    function renderCal() {
        const g = document.getElementById('cal-g'); g.innerHTML = '';
        const y = curMonth.getFullYear(), m = curMonth.getMonth();
        document.getElementById('cal-m-label').innerText = `${y}å¹´ ${m+1}æœˆ`;
        const first = new Date(y, m, 1).getDay(), days = new Date(y, m+1, 0).getDate(), offset = (first === 0 ? 6 : first - 1);
        for(let i=0; i<offset; i++) g.innerHTML += '<div></div>';
        for(let d=1; d<=days; d++) {
            const dateObj = new Date(y, m, d), k = dateObj.toLocaleDateString();
            const l = Solar.fromDate(dateObj).getLunar();
            const f = l.getFestivals()[0] || l.getJieQi() || "";
            const el = document.createElement('div');
            el.className = `day ${k===new Date().toLocaleDateString()?'is-today':''} ${dataMap.has(k)?'recorded':''}`;
            const labelColor = f ? 'var(--danger)' : 'var(--sub)';
            el.innerHTML = `<span>${d}</span><span class="l" style="color:${labelColor}">${f === "é¾™å¤´èŠ‚" ? "é¾™æŠ¬å¤´" : (f || l.getDayInChinese())}</span>`;
            el.onclick = () => openNote(k); g.appendChild(el);
        }
    }

    function openNote(k) {
        curKey = k; document.getElementById('d-date-title').innerText = k.replace(/\//g, ' . ');
        const d = dataMap.get(k); d ? showView(d) : enterEdit();
        document.getElementById('d-page').classList.remove('page-hidden');
    }

    function showView(d) {
        isEditState = false; document.getElementById('v-box').style.display='block'; document.getElementById('e-box').style.display='none';
        document.getElementById('v-tools').style.display='block'; document.getElementById('e-tools').style.display='none';
        document.getElementById('title-v').innerText=d.title || "Untitled";
        document.getElementById('meta-v').innerText=`${d.mood ? d.mood.replace(/,/g, ' ') + ' Â· ' : ''}${d.words} å­—`;
        document.getElementById('content-v').innerText = d.content;
    }

    function enterEdit() {
        isEditState = true; const d = dataMap.get(curKey);
        document.getElementById('e-content').focus();
        document.getElementById('v-box').style.display='none'; document.getElementById('e-box').style.display='block';
        document.getElementById('v-tools').style.display='none'; document.getElementById('e-tools').style.display='block';
        document.getElementById('e-title').value = d?d.title:''; document.getElementById('e-content').value = d?d.content:'';
        activeMoods = d && d.mood ? d.mood.split(',') : []; updateMoodDisplay(); updateWC();
    }

    function openMoodModal() { document.getElementById('mood-modal').style.display = 'flex'; updateMoodTags(); }
    function closeMoodModal() { document.getElementById('mood-modal').style.display = 'none'; }
    function updateMoodTags() { 
        document.querySelectorAll('.mood-tag').forEach(t => t.classList.toggle('active', activeMoods.includes(t.innerText)));
        const disp = document.getElementById('selected-moods-display'); disp.innerHTML = '';
        activeMoods.forEach(m => {
            const tag = document.createElement('div'); tag.className = 'mood-tag active'; tag.innerText = m;
            tag.onclick = () => { activeMoods = activeMoods.filter(x => x !== m); updateMoodTags(); updateMoodDisplay(); save(false); };
            disp.appendChild(tag);
        });
    }
    
    function toggleMood(el) {
        const m = el.innerText;
        if(activeMoods.includes(m)) activeMoods = activeMoods.filter(x => x !== m);
        else if(activeMoods.length < 5) activeMoods.push(m);
        updateMoodTags(); updateMoodDisplay(); save(false);
    }
    function addCustomMood() {
        const i = document.getElementById('custom-mood-i');
        if(i.value && activeMoods.length < 5) { activeMoods.push(i.value); i.value=''; updateMoodTags(); updateMoodDisplay(); save(false); }
    }
    function updateMoodDisplay() { document.getElementById('mood-trigger-btn').innerText = activeMoods.length ? activeMoods.join(', ') : 'è®°å½•æ­¤åˆ»å¿ƒæƒ…...'; }

    function save(manual) {
        const c = document.getElementById('e-content').value;
        const d = { date: curKey, title: document.getElementById('e-title').value, content: c, mood: activeMoods.join(','), words: c.length };
        db.transaction("notes", "readwrite").objectStore("notes").put(d).onsuccess = () => { 
            sync(); if(manual) showView(d); else {
                document.getElementById('save-hint').innerText="å·²å­˜ "+new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                setTimeout(()=>document.getElementById('save-hint').innerText='', 2000);
            }
        };
    }

    function updateWC() { if (!isComposing) document.getElementById('wc-d').innerText = document.getElementById('e-content').value.length; }
    function moveMonth(s) { curMonth.setMonth(curMonth.getMonth()+s); sync(); }
    function goToday() { curMonth = new Date(); sync(); }
    function closePage() { document.getElementById('d-page').classList.add('page-hidden'); }
    function goRandom() { const ks = Array.from(dataMap.keys()); if(ks.length) openNote(ks[Math.floor(Math.random()*ks.length)]); }
    function exportJSON() { db.transaction("notes", "readonly").objectStore("notes").getAll().onsuccess = (e) => { const blob = new Blob([JSON.stringify(e.target.result)], {type:"application/json"}); const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`ShiXu_Backup_${new Date().toLocaleDateString()}.json`; a.click(); }; }
    function importJSON(i) { const r = new FileReader(); r.onload=(e)=>{ try { const data = JSON.parse(e.target.result); const tx = db.transaction("notes", "readwrite"); data.forEach(n => tx.objectStore("notes").put(n)); tx.oncomplete = () => { sync(); alert("æ¢å¤æˆåŠŸ"); }; } catch(err) { alert("æ ¼å¼é”™è¯¯"); } }; r.readAsText(i.files[0]); }
    function showPwdModal() { document.getElementById('pwd-modal').style.display = 'flex'; }
    function updatePassword() {
        const old = document.getElementById('old-pwd').value, nw = document.getElementById('new-pwd').value;
        if(btoa(old) === localStorage.getItem(PWD_KEY)) { localStorage.setItem(PWD_KEY, btoa(nw)); alert("ä¿®æ”¹æˆåŠŸ"); document.getElementById('pwd-modal').style.display='none'; } else alert("æ—§å¯†ç é”™è¯¯");
    }
    async function clearAllData() { if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ")) { db.transaction("notes", "readwrite").objectStore("notes").clear().onsuccess = () => { sync(); location.reload(); }; } }
    async function doDel() { if(confirm("ç¡®å®šåˆ é™¤æ­¤ç¯‡çµæ„Ÿå—ï¼Ÿ")) { const tx = db.transaction("notes", "readwrite"); tx.objectStore("notes").delete(curKey).onsuccess = () => { sync(); closePage(); }; } }
    
    const editor = document.getElementById('e-content');
    editor.addEventListener('compositionstart', () => isComposing = true);
    editor.addEventListener('compositionend', () => { isComposing = false; updateWC(); });
    editor.addEventListener('input', () => { updateWC(); clearTimeout(autoSaveTimer); autoSaveTimer=setTimeout(()=>isEditState&&save(false), 3000); });
    
    // é”®ç›˜è”åŠ¨é€»è¾‘ï¼ˆè™½ç„¶æ— å·¥å…·æ ï¼Œä½†ä¿ç•™ä»¥åŒæ­¥ SaveHint ä½ç½®ï¼‰
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            const hint = document.getElementById('save-hint');
            if (isEditState) {
                const offset = window.innerHeight - window.visualViewport.height;
                hint.style.bottom = offset > 50 ? `${offset + 30}px` : '30px';
            }
        });
    }

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) lastHiddenTime = Date.now();
        else {
            if (lastHiddenTime && (Date.now() - lastHiddenTime > 300000)) {
                document.getElementById('auth-layer').style.display = 'flex';
                document.getElementById('pwd-i').value = '';
            }
            if (isEditState) editor.focus();
        }
    });
</script>
</body>
</html>