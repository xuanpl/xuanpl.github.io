<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ‹¾ç»ªPro Â· çµæ„Ÿæ—¥è®°</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --accent: #d4af37; --bg: #f8f9fa; --card: #ffffff; --text: #2c3e50; 
            --danger: #e74c3c; --sub: #525c68; --mood-bg: #e9ecef;
            --energy: 243, 156, 18; --healing: 39, 174, 96; --thinking: 41, 128, 185;
            --release: 231, 76, 60; --melancholy: 52, 73, 94; --fear: 26, 26, 26; --custom: 142, 68, 173;
        }
        @media (prefers-color-scheme: dark) {
            :root { --primary: #ecf0f1; --accent: #f1c40f; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --sub: #a4b0be; --mood-bg: #2c2c2c; }
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background: var(--bg); overflow: hidden; }
        body { font-family: -apple-system, system-ui; color: var(--text); padding-bottom: env(safe-area-inset-bottom); }
        
        /* é¡µé¢å®¹å™¨ */
        .page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: var(--bg); z-index: 10; overflow-y: auto; padding-top: env(safe-area-inset-top); }
        .page-hidden { transform: translateX(100%); opacity: 0; pointer-events: none; }
        
        /* é¦–é¡µå¸ƒå±€ */
        .home-header { padding: 40px 25px 5px; display: flex; justify-content: space-between; align-items: flex-start; }
        .home-header h1 { font-size: 22px; font-weight: 200; margin: 0; letter-spacing: 1px; }
        .settings-btn { background: none; border: none; padding: 5px; cursor: pointer; }
        .settings-btn svg { width: 20px; height: 20px; fill: var(--sub); }
        .mini-stats { display: flex; gap: 15px; margin: 0 25px 8px; color: var(--sub); }
        .stat-val { font-size: 16px; font-weight: 300; margin-top: 1px; color: var(--text); }
        .stat-label { font-size: 9px; text-transform: uppercase; opacity: 0.6; }

        .cal-section { margin: 8px 15px; border-radius: 20px; background: var(--card); box-shadow: 0 5px 25px rgba(0,0,0,0.03); padding-bottom: 8px; }
        .cal-ctrl { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
        .nav-group { display: flex; align-items: center; gap: 12px; }
        .today-btn { font-size: 10px; color: var(--accent); font-weight: 600; background: var(--mood-bg); padding: 5px 14px; border-radius: 20px; }
        .cal-btn { background: var(--mood-bg); border: none; width: 34px; height: 34px; border-radius: 50%; color: var(--text); display: flex; align-items: center; justify-content: center; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); padding: 0 8px; gap: 1px; }
        .day { height: 56px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; margin: 1px; position: relative; }
        .day span:first-child { font-size: 16px; font-weight: 600; }
        .day .l { font-size: 9.5px; margin-top: 2px; letter-spacing: -0.2px; white-space: nowrap; }
        .day.recorded { background: var(--mood-bg); }
        .day.is-today { background: var(--primary) !important; color: var(--bg); }
        .day.recorded::after { content: ''; position: absolute; bottom: 5px; width: 3px; height: 3px; background: var(--accent); border-radius: 50%; }

        .section-box { margin: 8px 15px; padding: 15px 18px; background: var(--card); border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.03); }
        .box-header { font-size: 11px; font-weight: 700; margin-bottom: 12px; color: var(--sub); display: flex; justify-content: space-between; }
        .growth-grid { display: flex; flex-wrap: wrap; gap: 4px; }
        .growth-cell { width: 11px; height: 11px; border-radius: 2px; background: var(--mood-bg); }

        .search-i { width: 100%; padding: 12px 18px; border-radius: 14px; border: none; background: var(--mood-bg); color: var(--text); font-size: 14px; }
        .walk-btn { width: 100%; margin-top: 15px; background: var(--primary); color: var(--bg); border: none; padding: 14px; border-radius: 14px; font-size: 13px; font-weight: 600; }

        /* ç¼–è¾‘/æŸ¥çœ‹é¡µé¢ */
        .toolbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; position: sticky; top:0; background: var(--bg); z-index: 20; }
        .btn-pill { font-size: 13px; font-weight: 600; padding: 8px 22px; border-radius: 16px; border: none; background: var(--mood-bg); color: var(--primary); min-width: 80px; text-align: center; }
        .btn-save { background: var(--primary); color: var(--bg); }
        .btn-del { color: var(--danger); font-size: 12px; font-weight: bold; background: none; border: none; margin-right: 15px; }
        
        .reading-container { padding: 20px 25px 200px; max-width: 650px; margin: 0 auto; }
        #title-v { font-size: 28px; font-weight: 700; margin-bottom: 12px; line-height: 1.3; }
        .meta-v { font-size: 11px; color: var(--sub); margin-bottom: 20px; border-left: 3px solid var(--accent); padding-left: 10px; }
        .text-v { font-size: 17px; line-height: 1.9; color: var(--sub); white-space: pre-wrap; }
        .text-v strong { color: var(--primary); border-bottom: 2px solid var(--accent); font-weight: 800; }
        .text-v u { text-decoration: underline; text-decoration-color: var(--accent); text-underline-offset: 4px; }
        .text-v blockquote { border-left: 4px solid var(--mood-bg); margin: 15px 0; padding: 10px 15px; background: rgba(0,0,0,0.02); color: var(--sub); font-style: italic; }
        .text-v del { color: var(--sub); opacity: 0.6; }

        .mood-trigger { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: var(--mood-bg); border-radius: 20px; font-size: 12px; color: var(--sub); margin-bottom: 15px; }
        
        /* æ™ºèƒ½å¸åº•å·¥å…·æ  */
        .edit-tools { 
            position: fixed; left: 0; width: 100%; 
            padding: 10px 15px; 
            background: rgba(248, 249, 250, 0.95); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--mood-bg); z-index: 150; 
            display: none; gap: 6px; justify-content: center;
            bottom: 0; padding-bottom: calc(10px + env(safe-area-inset-bottom));
            transition: bottom 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        @media (prefers-color-scheme: dark) { .edit-tools { background: rgba(18, 18, 18, 0.95); } }
        .tool-btn { padding: 8px 10px; font-size: 11px; border-radius: 10px; background: var(--card); border: 1px solid var(--mood-bg); color: var(--sub); font-weight: 600; flex: 1; text-align: center; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: flex-end; }
        .modal-content { background: var(--card); width: 100%; border-radius: 25px 25px 0 0; padding: 30px 20px; }
        .mood-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; justify-content: center; }
        .mood-tag { padding: 9px 15px; background: var(--mood-bg); border-radius: 15px; font-size: 12px; color: var(--sub); border: 1px solid transparent; }
        .mood-tag.active { border-color: var(--accent); color: var(--accent); font-weight: 700; background: var(--card); }
        
        #auth-layer { position:fixed; inset:0; background:var(--bg); z-index:300; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #pwd-i { padding:14px; border:none; background:var(--mood-bg); color:var(--text); border-radius:20px; margin-bottom:20px; text-align:center; font-size: 24px; width:200px; }
		
		/* çƒ­åŠ›å›¾è‰²é˜¶å®šä¹‰ï¼šç¡®ä¿ 6 ç§å¿ƒæƒ…é¢œè‰²å…¨è¦†ç›– */
        .f-energy.lv-1 { background: rgba(var(--energy), 0.2); } .f-energy.lv-2 { background: rgba(var(--energy), 0.5); } .f-energy.lv-3 { background: rgba(var(--energy), 1.0); }
        .f-healing.lv-1 { background: rgba(var(--healing), 0.2); } .f-healing.lv-2 { background: rgba(var(--healing), 0.5); } .f-healing.lv-3 { background: rgba(var(--healing), 1.0); }
        .f-thinking.lv-1 { background: rgba(var(--thinking), 0.2); } .f-thinking.lv-2 { background: rgba(var(--thinking), 0.5); } .f-thinking.lv-3 { background: rgba(var(--thinking), 1.0); }
        .f-release.lv-1 { background: rgba(var(--release), 0.2); } .f-release.lv-2 { background: rgba(var(--release), 0.5); } .f-release.lv-3 { background: rgba(var(--release), 1.0); }
        .f-melancholy.lv-1 { background: rgba(var(--melancholy), 0.2); } .f-melancholy.lv-2 { background: rgba(var(--melancholy), 0.5); } .f-melancholy.lv-3 { background: rgba(var(--melancholy), 1.0); }
        .f-fear.lv-1 { background: rgba(var(--fear), 0.2); } .f-fear.lv-2 { background: rgba(var(--fear), 0.5); } .f-fear.lv-3 { background: rgba(var(--fear), 1.0); }
        .f-custom.lv-1 { background: rgba(var(--custom), 0.2); } .f-custom.lv-2 { background: rgba(var(--custom), 0.5); } .f-custom.lv-3 { background: rgba(var(--custom), 1.0); }
    </style>
</head>
<body>

<div id="auth-layer">
    <h2 style="font-weight:200; letter-spacing:10px;">æ‹¾ç»ªPro</h2>
    <input type="password" id="pwd-i" placeholder="Unlock" autocomplete="off">
    <button class="btn-pill btn-save" onclick="checkAuth()">è§£é”</button>
</div>

<div id="settings-modal" class="modal" onclick="this.style.display='none'"><div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="margin:0 0 20px; font-weight:300">ç³»ç»Ÿè®¾ç½®</h3>
    <button class="btn-pill" style="width:100%; margin-bottom:10px; text-align:left;" onclick="exportJSON()">å¤‡ä»½çµæ„Ÿ (Export) â†’</button>
    <button class="btn-pill" style="width:100%; margin-bottom:10px; text-align:left;" onclick="document.getElementById('file-i').click()">æ¢å¤çµæ„Ÿ (Import) â†’</button>
    <button class="btn-pill" style="width:100%; margin-bottom:10px; text-align:left;" onclick="showPwdModal()">ä¿®æ”¹è®¿é—®å¯†ç  â†’</button>
    <button class="btn-pill" style="width:100%; color:var(--danger); text-align:left;" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰è®°å½• âš ï¸</button>
    <input type="file" id="file-i" style="display:none" onchange="importJSON(this)">
    <button class="btn-pill btn-save" style="width:100%; margin-top:20px;" onclick="document.getElementById('settings-modal').style.display='none'">å…³é—­</button>
</div></div>

<div id="pwd-modal" class="modal" onclick="this.style.display='none'"><div class="modal-content" onclick="event.stopPropagation()">
    <h3>ä¿®æ”¹è®¿é—®å¯†ç </h3>
    <input type="password" id="old-pwd" style="width:100%; padding:14px; margin-bottom:10px; border-radius:12px; border:1px solid var(--mood-bg);" placeholder="æ—§å¯†ç ">
    <input type="password" id="new-pwd" style="width:100%; padding:14px; margin-bottom:20px; border-radius:12px; border:1px solid var(--mood-bg);" placeholder="æ–°å¯†ç ">
    <button class="btn-pill btn-save" style="width:100%" onclick="updatePassword()">ç¡®è®¤ä¿®æ”¹</button>
</div></div>

<div id="mood-modal" class="modal" onclick="closeMoodModal()"><div class="modal-content" onclick="event.stopPropagation()">
    <div class="mood-grid" id="mood-grid-main">
        <div class="mood-tag" onclick="toggleMood(this)">ğŸ’¡ çµæ„Ÿ</div><div class="mood-tag" onclick="toggleMood(this)">ğŸš€ åŠ¨åŠ›</div><div class="mood-tag" onclick="toggleMood(this)">ğŸŒˆ å¿«ä¹</div>
        <div class="mood-tag" onclick="toggleMood(this)">ğŸ˜Š å¹³é™</div><div class="mood-tag" onclick="toggleMood(this)">ğŸŒ¿ æˆé•¿</div><div class="mood-tag" onclick="toggleMood(this)">â˜• æ‚ é—²</div>
        <div class="mood-tag" onclick="toggleMood(this)">ğŸ“ æ€è€ƒ</div><div class="mood-tag" onclick="toggleMood(this)">ğŸ¤” ç–‘æƒ‘</div><div class="mood-tag" onclick="toggleMood(this)">ğŸŒ‘ å®³æ€•</div>
        <div class="mood-tag" onclick="toggleMood(this)">ğŸ’¢ æ°”æ„¤</div><div class="mood-tag" onclick="toggleMood(this)">ğŸ˜¢ ä½è½</div>
    </div>
    <div style="display:flex; gap:8px;">
        <input type="text" id="custom-mood-i" placeholder="æ·»åŠ è‡ªå®šä¹‰å¿ƒæƒ…..." style="flex:1; border:none; background:var(--mood-bg); padding:10px; border-radius:10px; font-size:12px;">
        <button class="btn-pill" onclick="addCustomMood()">æ·»åŠ </button>
    </div>
    <div id="selected-moods-display" style="margin-top:15px; display:flex; flex-wrap:wrap; gap:5px;"></div>
    <button class="btn-pill btn-save" style="width:100%; margin-top:20px;" onclick="closeMoodModal()">å®Œæˆ</button>
</div></div>

<div id="h-page" class="page">
    <div class="home-header">
        <h1>æ‹¾ç»ªPro Â· çµæ„Ÿæ—¥è®°</h1>
        <button class="settings-btn" onclick="document.getElementById('settings-modal').style.display='flex'">
            <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.13,5.91,7.62,6.29L5.23,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.72,8.87 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.81,11.68,4.81,12c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.50,0.38,1.03,0.70,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
        </button>
    </div>
    <div class="mini-stats">
        <div class="stat-group"><span class="stat-label">Total</span><span class="stat-val" id="s-total">0</span></div>
        <div class="stat-group"><span class="stat-label">Month</span><span class="stat-val" id="s-month">0</span></div>
        <div class="stat-group"><span class="stat-label">Words</span><span class="stat-val" id="s-words">0</span></div>
    </div>
    <div class="cal-section">
        <div class="cal-ctrl"><div id="cal-m-label" style="font-weight:600; font-size:16px;"></div><div class="nav-group"><button class="cal-btn" onclick="moveMonth(-1)">â—€</button><div class="today-btn" onclick="goToday()">ä»Šå¤©</div><button class="cal-btn" onclick="moveMonth(1)">â–¶</button></div></div>
        <div class="cal-grid" id="cal-g"></div>
    </div>
    <div class="section-box">
        <div class="box-header"><span>çµæ„Ÿè¶³è¿¹</span><span id="days-count">0 Days</span></div>
        <div class="growth-grid" id="growth-grid"></div>
    </div>
    <div class="section-box">
        <div class="box-header"><span>çµæ„Ÿç´¢å¼•</span><span style="color:var(--accent)">Search</span></div>
        <input type="text" class="search-i" id="search-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." oninput="filterIndex()">
        <div id="index-list" style="margin-top:10px;"></div>
        <button class="walk-btn" onclick="goRandom()">âœ¨ éšæœºæ¼«æ­¥</button>
    </div>
</div>

<div id="d-page" class="page page-hidden">
    <div class="toolbar">
        <button class="btn-pill" onclick="closePage()">è¿”å›</button>
        <span id="d-date-title" style="font-size:11px; opacity:0.3; font-weight:700;"></span>
        <div id="v-tools"><button class="btn-del" onclick="doDel()">åˆ é™¤</button> <button class="btn-pill btn-save" id="edit-btn" onclick="enterEdit()">ç¼–è¾‘</button></div>
        <div id="e-tools" style="display:none"><button class="btn-pill btn-save" onclick="save(true)">ä¿å­˜</button></div>
    </div>
    <div class="reading-container">
        <div id="v-box"><h2 id="title-v"></h2><div class="meta-v" id="meta-v"></div><div class="text-v" id="content-v"></div></div>
        <div id="e-box" style="display:none">
            <div class="mood-trigger" id="mood-trigger-btn" onclick="openMoodModal()">é€‰æ‹©å¿ƒæƒ…...</div>
            <input type="text" id="e-title" placeholder="ç»™ä»Šå¤©å®‰ä¸ªæ ‡é¢˜..." style="width:100%; border:none; background:none; font-size:24px; font-weight:600; margin-bottom:15px; outline:none; color:var(--text);">
            <textarea id="e-content" placeholder="å¿ƒæƒ…ã€éšç¬”ã€æˆ–æ˜¯æŸä¸ªç¬é—´çš„çµæ„Ÿ..." style="width:100%; border:none; background:none; font-size:17px; line-height:1.9; min-height:60vh; outline:none; color:var(--text);"></textarea>
            <div id="wc-d-box" style="font-size:10px; color:var(--sub); margin-top:10px; font-weight:700;">å­—æ•°ï¼š<span id="wc-d">0</span></div>
        </div>
    </div>
    <div id="save-hint" style="position:fixed; bottom:120px; right:25px; font-size:10px; color:var(--sub); font-weight: bold; z-index:150;"></div>
</div>

<div class="edit-tools" id="float-tools">
    <button class="tool-btn" onclick="wrapText('**')">åŠ ç²—</button>
    <button class="tool-btn" onclick="wrapText('__')">ä¸‹åˆ’çº¿</button>
    <button class="tool-btn" onclick="wrapText('~~')">åˆ é™¤çº¿</button>
    <button class="tool-btn" onclick="wrapText('> ')">å¼•ç”¨</button>
    <button class="tool-btn" onclick="wrapText('- ')">åˆ—è¡¨</button>
</div>

<script>
    let db, curMonth = new Date(), curKey = '', dataMap = new Map();
    let isEditState = false, activeMoods = [], autoSaveTimer = null, isComposing = false, lastHiddenTime = 0;
    const PWD_KEY = 'ShiXuPro_Permanent_PWD';
    const moodFamilies = {
        'ğŸ’¡ çµæ„Ÿ': 'f-energy', 'ğŸš€ åŠ¨åŠ›': 'f-energy', 'ğŸŒˆ å¿«ä¹': 'f-energy',
        'ğŸ˜Š å¹³é™': 'f-healing', 'ğŸŒ¿ æˆé•¿': 'f-healing', 'â˜• æ‚ é—²': 'f-healing',
        'ğŸ“ æ€è€ƒ': 'f-thinking', 'ğŸ¤” ç–‘æƒ‘': 'f-thinking',
        'ğŸŒ‘ å®³æ€•': 'f-fear', 'ğŸ’¢ æ°”æ„¤': 'f-release', 'ğŸ˜¢ ä½è½': 'f-melancholy'
    };

    function checkAuth() {
        const v = document.getElementById('pwd-i').value, s = localStorage.getItem(PWD_KEY);
        if(!s) { if(v.length < 1) return alert("è®¾ç½®åˆå§‹å¯†ç "); localStorage.setItem(PWD_KEY, btoa(v)); start(); }
        else if(btoa(v) === s) { start(); lastHiddenTime = 0; } else { alert("å¯†ç é”™è¯¯"); document.getElementById('pwd-i').value=''; }
    }

    function start() {
        document.getElementById('auth-layer').style.display='none';
        const req = indexedDB.open("ShiXuPro_Official_DB", 1);
        req.onupgradeneeded = (e) => { 
            const dbRef = e.target.result;
            if(!dbRef.objectStoreNames.contains("notes")) dbRef.createObjectStore("notes", {keyPath: "date"}); 
        };
        req.onsuccess = (e) => { db = e.target.result; sync(); };
    }

    async function sync() {
        const tx = db.transaction("notes", "readonly");
        const all = await new Promise(r => tx.objectStore("notes").getAll().onsuccess = (e) => r(e.target.result));
        dataMap.clear(); let tw = 0, mc = 0, recordedDates = new Set();
        const prefix = curMonth.toLocaleDateString().split('/').slice(0,2).join('/');
        all.forEach(n => { dataMap.set(n.date, n); tw += (n.words || 0); recordedDates.add(n.date); if(n.date.startsWith(prefix)) mc++; });
        document.getElementById('s-total').innerText = all.length;
        document.getElementById('s-month').innerText = mc;
        document.getElementById('s-words').innerText = tw.toLocaleString();
        document.getElementById('days-count').innerText = `${recordedDates.size} Days`;
        renderCal(); renderGrowthGrid(all);
    }

    function renderGrowthGrid(all) {
        const grid = document.getElementById('growth-grid'); grid.innerHTML = '';
        all.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(n => {
            const cell = document.createElement('div'), moods = n.mood ? n.mood.split(',') : [];
            const colorClass = moodFamilies[moods[0]] || (moods[0] ? 'f-custom' : '');
            const lv = n.words > 400 ? 'lv-3' : (n.words > 100 ? 'lv-2' : 'lv-1');
            cell.className = `growth-cell ${colorClass} ${lv}`;
            grid.appendChild(cell);
        });
    }

    function renderCal() {
        const g = document.getElementById('cal-g'); g.innerHTML = '';
        const y = curMonth.getFullYear(), m = curMonth.getMonth();
        document.getElementById('cal-m-label').innerText = `${y}å¹´ ${m+1}æœˆ`;
        const first = new Date(y, m, 1).getDay(), days = new Date(y, m+1, 0).getDate(), offset = (first === 0 ? 6 : first - 1);
        for(let i=0; i<offset; i++) g.innerHTML += '<div></div>';
        for(let d=1; d<=days; d++) {
            const dateObj = new Date(y, m, d);
            const k = dateObj.toLocaleDateString();
            const l = Solar.fromDate(dateObj).getLunar();
            const f = l.getFestivals()[0] || l.getJieQi() || "";
            const el = document.createElement('div');
            el.className = `day ${k===new Date().toLocaleDateString()?'is-today':''} ${dataMap.has(k)?'recorded':''}`;
            const labelColor = f ? 'var(--danger)' : 'var(--sub)';
            el.innerHTML = `<span>${d}</span><span class="l" style="color:${labelColor}">${f === "é¾™å¤´èŠ‚" ? "é¾™æŠ¬å¤´" : (f || l.getDayInChinese())}</span>`;
            el.onclick = () => openNote(k); g.appendChild(el);
        }
    }

    function filterIndex() {
        const q = document.getElementById('search-input').value.toLowerCase(), list = document.getElementById('index-list');
        list.innerHTML = ''; if(!q) return;
        Array.from(dataMap.values()).filter(n => (n.title+n.content).toLowerCase().includes(q)).forEach(n => {
            const item = document.createElement('div'); item.style = "padding:12px; border-bottom:1px solid var(--mood-bg); display:flex; justify-content:space-between; font-size:14px; font-weight:600;";
            item.onclick = () => openNote(n.date);
            item.innerHTML = `<span>${n.title || 'æ— æ ‡é¢˜'}</span><span style="opacity:0.4; font-size:11px;">${n.date}</span>`;
            list.appendChild(item);
        });
    }

    function openNote(k) {
        curKey = k; document.getElementById('d-date-title').innerText = k.replace(/\//g, ' . ');
        const d = dataMap.get(k); d ? showView(d) : enterEdit();
        document.getElementById('d-page').classList.remove('page-hidden');
    }

    function renderMD(t) {
        return t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<u>$1</u>')
                .replace(/~~(.*?)~~/g, '<del>$1</del>')
                .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');
    }

    function showView(d) {
        isEditState = false; document.getElementById('v-box').style.display='block'; document.getElementById('e-box').style.display='none';
        document.getElementById('v-tools').style.display='block'; document.getElementById('e-tools').style.display='none';
        document.getElementById('float-tools').style.display='none';
        document.getElementById('title-v').innerText=d.title || "æ— æ ‡é¢˜";
        document.getElementById('meta-v').innerText=`${d.mood ? d.mood.replace(/,/g, ' ') : ''} ${d.mood ? 'Â·' : ''} ${d.words} å­—`;
        document.getElementById('content-v').innerHTML = renderMD(d.content);
    }

    function enterEdit() {
        isEditState = true; const d = dataMap.get(curKey);
        // iOS å…³é”®ï¼šå¼ºåˆ¶åŒæ­¥èšç„¦ï¼Œé¿å¼€ Safari å¯¹å¼‚æ­¥å¼¹é”®ç›˜çš„é™åˆ¶
        document.getElementById('e-content').focus();
        
        document.getElementById('v-box').style.display='none'; document.getElementById('e-box').style.display='block';
        document.getElementById('v-tools').style.display='none'; document.getElementById('e-tools').style.display='block';
        document.getElementById('float-tools').style.display='flex';
        document.getElementById('e-title').value = d?d.title:''; document.getElementById('e-content').value = d?d.content:'';
        activeMoods = d && d.mood ? d.mood.split(',') : []; updateMoodDisplay(); updateWC();
    }

    function openMoodModal() { document.getElementById('mood-modal').style.display = 'flex'; updateMoodTags(); }
    function closeMoodModal() { document.getElementById('mood-modal').style.display = 'none'; }
    function updateMoodTags() { 
        document.querySelectorAll('.mood-tag').forEach(t => t.classList.toggle('active', activeMoods.includes(t.innerText)));
        const disp = document.getElementById('selected-moods-display'); disp.innerHTML = '';
        activeMoods.forEach(m => {
            const tag = document.createElement('div'); tag.className = 'mood-tag active'; tag.innerText = m;
            tag.onclick = () => { activeMoods = activeMoods.filter(x => x !== m); updateMoodTags(); updateMoodDisplay(); save(false); };
            disp.appendChild(tag);
        });
    }
    
    function toggleMood(el) {
        const m = el.innerText;
        if(activeMoods.includes(m)) activeMoods = activeMoods.filter(x => x !== m);
        else if(activeMoods.length < 5) activeMoods.push(m);
        updateMoodTags(); updateMoodDisplay(); save(false);
    }
    function addCustomMood() {
        const i = document.getElementById('custom-mood-i');
        if(i.value && activeMoods.length < 5) { activeMoods.push(i.value); i.value=''; updateMoodTags(); updateMoodDisplay(); save(false); }
    }
    function updateMoodDisplay() { document.getElementById('mood-trigger-btn').innerText = activeMoods.length ? activeMoods.join(', ') : 'é€‰æ‹©å¿ƒæƒ…...'; }

    function save(manual) {
        const c = document.getElementById('e-content').value;
        const d = { date: curKey, title: document.getElementById('e-title').value, content: c, mood: activeMoods.join(','), words: c.length };
        db.transaction("notes", "readwrite").objectStore("notes").put(d).onsuccess = () => { 
            sync(); if(manual) showView(d); else {
                document.getElementById('save-hint').innerText="å·²å­˜ "+new Date().toLocaleTimeString();
                setTimeout(()=>document.getElementById('save-hint').innerText='', 2000);
            }
        };
    }

    function wrapText(sym) {
        const el = document.getElementById('e-content'), start = el.selectionStart, end = el.selectionEnd, txt = el.value;
        if (sym === '- ' || sym === '> ') {
            const newline = start !== 0 && txt[start-1] !== '\n' ? '\n' : '';
            el.value = txt.slice(0, start) + newline + sym + txt.slice(start);
            el.selectionStart = el.selectionEnd = start + newline.length + sym.length;
        } else {
            const selected = txt.slice(start, end);
            if (selected.length > 0) {
                el.value = txt.slice(0, start) + sym + selected + sym + txt.slice(end);
            } else {
                el.value = txt.slice(0, start) + sym + sym + txt.slice(end);
                el.selectionStart = el.selectionEnd = start + sym.length;
            }
        }
        updateWC(); save(false); el.focus();
    }

    function updateWC() {
        if (isComposing) return;
        document.getElementById('wc-d').innerText = document.getElementById('e-content').value.length;
    }

    function moveMonth(s) { curMonth.setMonth(curMonth.getMonth()+s); renderCal(); }
    function goToday() { curMonth = new Date(); renderCal(); }
    function closePage() { document.getElementById('d-page').classList.add('page-hidden'); document.getElementById('float-tools').style.display='none'; }
    function goRandom() { const ks = Array.from(dataMap.keys()); if(ks.length) openNote(ks[Math.floor(Math.random()*ks.length)]); }
    function exportJSON() { db.transaction("notes", "readonly").objectStore("notes").getAll().onsuccess = (e) => { const b = new Blob([JSON.stringify(e.target.result)], {type:"application/json"}), a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download=`ShiXu_Backup.json`; a.click(); }; }
    function importJSON(i) { const r = new FileReader(); r.onload=(e)=>{ try { const d = JSON.parse(e.target.result), tx = db.transaction("notes", "readwrite"); d.forEach(n => tx.objectStore("notes").put(n)); tx.oncomplete = () => { sync(); alert("æ¢å¤æˆåŠŸ"); }; } catch(err) { alert("æ•°æ®æ ¼å¼é”™è¯¯"); } }; r.readAsText(i.files[0]); }
    function showPwdModal() { document.getElementById('pwd-modal').style.display = 'flex'; }
    function updatePassword() {
        const old = document.getElementById('old-pwd').value, nw = document.getElementById('new-pwd').value;
        if(btoa(old) === localStorage.getItem(PWD_KEY)) { localStorage.setItem(PWD_KEY, btoa(nw)); alert("ä¿®æ”¹æˆåŠŸ"); document.getElementById('pwd-modal').style.display='none'; } else alert("æ—§å¯†ç é”™è¯¯");
    }
	async function clearAllData() {
		if(confirm("ç¡®å®šæ°¸ä¹…æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) {
			const tx = db.transaction("notes", "readwrite");
			tx.objectStore("notes").clear().onsuccess = () => {
				sync(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
				document.getElementById('settings-modal').style.display='none'; // åªå…³é—­å¼¹çª—ï¼Œä¸é‡è½½é¡µé¢
				alert("å·²æ¸…ç©ºæ‰€æœ‰æœ¬åœ°è®°å½•");
			};
		}
	}
    async function doDel() { if(confirm("ç¡®å®šåˆ é™¤æ­¤ç¯‡çµæ„Ÿå—ï¼Ÿ")) { const tx = db.transaction("notes", "readwrite"); tx.objectStore("notes").delete(curKey).onsuccess = () => { sync(); closePage(); }; } }
    
    const editor = document.getElementById('e-content');
    editor.addEventListener('compositionstart', () => isComposing = true);
    editor.addEventListener('compositionend', () => { isComposing = false; updateWC(); });
    editor.addEventListener('input', () => { updateWC(); clearTimeout(autoSaveTimer); autoSaveTimer=setTimeout(()=>isEditState&&save(false), 3000); });
    
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            const tools = document.getElementById('float-tools');
            const hint = document.getElementById('save-hint');
            if (isEditState) {
                const offset = window.innerHeight - window.visualViewport.height;
                if (offset > 50) {
                    tools.style.bottom = `${offset}px`; tools.style.paddingBottom = '10px';
                    hint.style.bottom = `${offset + 50}px`;
                } else {
                    tools.style.bottom = '0px'; tools.style.paddingBottom = 'calc(10px + env(safe-area-inset-bottom))';
                    hint.style.bottom = '120px';
                }
            }
        });
    }

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) lastHiddenTime = Date.now();
        else {
            if (lastHiddenTime && (Date.now() - lastHiddenTime > 300000)) {
                document.getElementById('auth-layer').style.display = 'flex';
                document.getElementById('pwd-i').value = ''; document.getElementById('float-tools').style.display = 'none';
            }
            if (isEditState) editor.focus();
        }
    });
</script>
</body>
</html>